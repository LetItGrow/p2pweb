<html>
<head>
  <link rel="stylesheet" href="style.css">
  <script src="/js/tinymce/tinymce.min.js"></script>
  <script src="/js/jsencrypt/jsencrypt.min.js"></script>
  <script src="/js/jsrsasign/jsrsasign-latest-all-min.js"></script>
  <!--script src="/js/jsencryptsign.js"></script-->
  <script src="/js/jssha/sha1.js"></script>
  <script src="/js/keygen.js"></script>
  <script src="/js/router.js"></script>
  <script src="/js/showhide.js"></script>
  <script src="/js/sha1hex.js"></script>
  <script src="/js/signedheader.js"></script>
  <script src="/js/blob/Blob.js"></script>
  <script src="/js/filesaver/FileSaver.js"></script>
  
  <script type="text/javascript">
  
    //
    // Hashing and signing
    //
    
    sha1bin = function(x) {
      return atob((new jsSHA(x, "TEXT")).getHash("SHA-1", "B64"));
    };
    
    var sign = function(crypt) {
      var rsa = new RSAKey();
      rsa.readPrivateKeyFromPEMString(crypt.getPrivateKey());
      return function(text){
        //return crypt.sign(text, sha1hex);
        return rsa.signString(text, "sha1");
      };
    };
    
    var checksign = function(text, sign, pubkey) {
      //var crypt = new JSEncrypt();
      //crypt.setKey(pubkey);
      //return crypt.verify(text, sign, sha1hex);
      var rsa = KEYUTIL.getKey("-----BEGIN PUBLIC KEY-----\n" + pubkey + "\n-----END PUBLIC KEY-----");
      return rsa.verifyString(text, sign);
    };
    
    //
    // Communication with server
    //
    
    var sendBlob = function(blob, blobid, content_type, cb){
      if(typeof blobid == "function") {
        cb = blobid;
        blobid = sha1hex(blob);
      }
      var r = new XMLHttpRequest();
      r.open("PUT", "/obj/" + blobid);
      r.setRequestHeader("Content-Type", content_type);
      r.onreadystatechange = function(){
        if(!r.status) return;
        if(r.status >= 400) cb(r);
        else cb(null, blobid);
        r.onreadystatechange = undefined;
      };
      r.send(blob);
    }
    
    //
    // Rich text editor
    //
    
    var initEditor = function(selector, onsave){
      tinymce.init({
        selector: selector,
        content_css: "style.css",
        plugins: "save autolink autoresize code hr link fullpage media image paste table",
        browser_spellcheck : true,
        
        // http://www.tinymce.com/wiki.php/Controls
        toolbar: "save | undo redo | code | formatselect styleselect removeformat | bullist numlist | blockquote | link image media table hr",
        menubar : false,
        
        target_list: false, // link
        paste_data_images: true, // paste
        
        formats: {
            alignleft: {selector: 'p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img', classes: 'left'},
            aligncenter: {selector: 'p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img', classes: 'center'},
            alignright: {selector: 'p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img', classes: 'right'},
            alignfull: {selector: 'p,h1,h2,h3,h4,h5,h6,td,th,div,ul,ol,li,table,img', classes: 'justify'},
            bold: {inline: 'strong'},
            italic: {inline: 'em'},
            underline: {inline: 'add'},
            strikethrough: {inline: 'del'}
        },
      
        save_enablewhendirty: false,  
        save_onsavecallback: onsave
      });
    };
    
    //
    // Generate Key
    //
    
    var keygen = new KeyGen(document.querySelector(".privkey"));
    
    //
    // SignedHeader
    //
    
    var currentSite;
    
    var saveCurrentSite = function() {
      //console.log(currentSite);
      sendBlob(currentSite.text, currentSite.getFirstId(sha1hex), "application/vnd.p2pws", function(r, id){
        if(r) {
          console.error(r.status + ' ' + r.statusText);
          alert("Error: could not save site to the server.\n" + r.status + " " + r.statusText);
        } else {
          //console.log("PUT /obj/" + id + " ok");
        }
      });
    };
      
  
    //
    // Routing
    //
  
    var r = new Router();

    r["/site/new"] = function(){
      document.querySelectorAll("section.showhide").hide();
      document.querySelectorAll("#section-new-website").show();
      var text = document.querySelector("textarea.p2pws");
      
      keygen.onkey = function(crypt){
        currentSite = new SignedHeader();
        currentSite.addHeader("Format", "P2P Website");
        currentSite.addHeader("PublicKey", crypt.getKey().getPublicBaseKeyB64());
        currentSite.addSignature(sign(crypt));
        //var dgst = crypt.sign("text", sha1hex);
        //console.log("Sign 'text': " + dgst);
        //console.log("Verify 'text': " + crypt.verify("text", dgst, sha1hex));
        /*
        var rsa = new RSAKey();
        rsa.readPrivateKeyFromPEMString(crypt.getPrivateKey());
        var hSig = rsa.signString("text", "sha1");
        
        console.log("Sign 'text': " + hSig);
        
        console.log(crypt.getPublicKey());
        
        var rsa = KEYUTIL.getKey("-----BEGIN PUBLIC KEY-----\n" + crypt.getPublicKeyB64() + "\n-----END PUBLIC KEY-----");
        var val = rsa.verifyString("text", hSig);
        console.log("Verify 'text': " + val);
        */
        saveCurrentSite();
        text.textContent = currentSite.text;
      };
    };

    r["/site/page/new"] = function(){
      if(!currentSite) window.location = "#!/site/new";
      document.querySelectorAll("section.showhide").hide();
      document.querySelectorAll("#section-new-website").show();
      document.querySelectorAll("#section-new-page").show();
      var title = document.querySelector("#section-new-page input[name=title]");
      var link  = document.querySelector("#section-new-page input[name=link]");
      var text  = document.querySelector("textarea.p2pws");
      title.addEventListener('input', function(){
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth()+1; //January is 0!
        var yyyy = today.getFullYear();
        if(dd<10) dd='0'+dd;
        if(mm<10) mm='0'+mm;
        var val = '/' + yyyy + '-' + mm + '-' + dd + '-' + title.value.replace(/[^a-zA-Z0-9_-]+/g, '_') + '.html';
        if((link.generatedValue || "") == link.value) {
          link.value = val;
          link.generatedValue = val;
          link.size = Math.max(link.getAttribute('size') || 10, val.length);
        }
      });
      var inputs = document.querySelectorAll("#section-new-page input[type=text]");
      for(var i = 0; i < inputs.length; i++) {
        inputs[i].addEventListener('input', function(){
          this.size = Math.max(this.getAttribute('size') || 10, this.value.length);
        });
      }
      initEditor("#section-new-page textarea.rich", function(document){
        var doc = document.getContent();
        var docid = sha1hex(doc);
        currentSite.addFile(link.value, docid, {'content-type': 'text/html; charset=utf-8'});
        text.textContent = currentSite.text;
        saveCurrentSite();
        sendBlob(doc, docid, "text/html; charset=utf-8", function(r, id){
          if(r) {
            console.error(r.status + ' ' + r.statusText);
            alert("Error: could not save to the server.\n" + r.status + " " + r.statusText);
          } else {
            //console.log("PUT /obj/" + id + " ok");
          }
        });
      });
    };
    
  </script>
</head>
<body>
  <p>Welcome to P2P Web</p>
  <nav>
    <ul>
      <li><a class="showhide" href="#section-shared-files">Shared Files</a></li>
      <li><a class="showhide" href="#section-published-websites">Published Websites</a></li>
      <li><a class="showhide" href="#!/site/new">New Website</a></li>
    </ul>
  </nav>
  <section class="showhide" id="section-shared-files">
    <h1>Shared Files</h1>
  </section>
  <section class="showhide" id="section-published-websites">
    <h1>Published Websites</h1>
  </section>
  <section class="showhide" id="section-new-website">
    <h1>New Website</h1>
    <section class="privkey">
      <p>Private key:
        <button class="btn-generate">Generate</button>
        <button class="btn-open">Open</button>
        <button class="btn-save">Save</button>
        <span></span>
        <input type="file" value="Open from file" style="display:none">
      </p>
    </section>
    <p>Pages:</p>
    <ul class="pagelist">
      <li><a href="#!/site/page/new">New Page</a></li>
    </ul>
    <textarea class="p2pws"></textarea>
    <section class="showhide" id="section-existing-pages">
    </section>
    <section class="showhide" id="section-new-page" class="pageform">
      <h2>New Page: <input type="text" name="title" placeholder="Page Title"/></h2>
      <p>
        <em>Created by <strong><input type="text" placeholder="name"/></strong> (<input type="text" placeholder="email or link"/>) on
        <strong><input type="date" placeholder="date"/></strong>
        <br/>Updated on <strong><input type="date" placeholder="date"/></strong>
        <br/>Link: <input type="text" name="link" value="" size="100"/>
        </em>
      </p>
      <textarea class="rich"></textarea>
    </section>
  </section>
  
</body>
</html>

